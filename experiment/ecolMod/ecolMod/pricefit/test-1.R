library(testthat)

.Random.seed <<- .ext.seed

test_that("pricefit", {
    cost <- genthat::with_env(function(par) sum((par[1] * sin(2 * pi * x/par[2] + par[3]) - y)^2), env = list2env(list(y = c(1.62762887120007, 
        -0.486845758681458, -5.44024044416118, 5.9710541650061, -6.00624561097837, 2.6128130394916, -0.213713887776263, 2.43171969352849, 
        -5.95396970834897, -3.06107750449476, 5.93873483875726, -1.96934533757992, -0.375003450188507, -5.93455486053906, 
        5.97733754634934, -0.9085335223974, -4.20094322539765, 3.87845132473401, 5.53595226099162, -1.39388010968203), x = c(11.8924785654526, 
        12.1819803728722, 3.71981395222247, 10.7958191388752, 8.34269174560905, 6.74824733869173, 9.57564809033647, 1.75066576409154, 
        8.54089977522381, 9.16584219248034, 5.95064309122972, 9.34845927148126, 12.1507392129861, 3.32057471643202, 6.00980669306591, 
        12.2201887958217, 12.7169435690157, 1.52733570151031, 6.17496206029318, 7.28432570118457)), parent = baseenv()))
    expect_equal(ecolMod:::pricefit(par = c(amplitude = 1, phase = 1, period = 1), minpar = c(0, 1e-08, 0), maxpar = c(100, 
        2 * pi, 100), func = cost, numiter = 3000), list(par = structure(c(6.03512934020447, 5.00983319665783, 0.522235119396706), 
        names = c("amplitude", "phase", "period")), cost = 0.0641633227587059, poppar = structure(c(6.03507959660291, 6.03491354725917, 
        6.03580527644778, 6.03369612304176, 6.03512229658017, 6.03383179092833, 6.0336205875541, 6.03422543336548, 6.03526292091932, 
        6.03433511992083, 6.03399924334161, 6.03423133142272, 6.03551982187775, 6.03405801409323, 6.03463906493808, 6.03463558019341, 
        6.03474999497632, 6.03370452037883, 6.03388197786063, 6.03494712503037, 6.03476134621326, 6.03402534522604, 6.03627643340809, 
        6.03558588019265, 6.03607004817166, 6.0360718869623, 6.03429110675663, 6.03559477502915, 6.03512934020447, 6.03512262804069, 
        6.0341677289113, 6.03475588155755, 6.03475418369691, 6.03446839419701, 6.03390568018144, 6.0339668761988, 6.03448039964689, 
        6.03587037474075, 6.03472199447316, 6.03385024650637, 6.03441097492768, 6.03513581142576, 6.03468006720746, 6.03467042480825, 
        6.03545344085701, 6.03416008612549, 6.03378681381002, 6.03337526975555, 6.0343880162026, 6.03469789388381, 5.00977238333747, 
        5.00978608428058, 5.00971390601135, 5.00968848778274, 5.00999032005063, 5.00983359047541, 5.00956334094227, 5.00973299674016, 
        5.009608445593, 5.0098314109187, 5.00979519898044, 5.00976554211731, 5.0098228118845, 5.00954972216145, 5.0095526176762, 
        5.00986453285194, 5.00968277933451, 5.00967507196715, 5.00980545172164, 5.00964894792512, 5.00978896519008, 5.00973342422293, 
        5.00985079675632, 5.00981989523097, 5.00991254264156, 5.00990649142823, 5.00968116797883, 5.00983525483211, 5.00983319665783, 
        5.0097438865697, 5.00962819958434, 5.00977916274046, 5.00966212707293, 5.00966998055724, 5.00966083374905, 5.00960438645385, 
        5.00990323269327, 5.0097653989542, 5.00962678488371, 5.009677655872, 5.00996423114759, 5.00974264719291, 5.00957448742225, 
        5.00969276803135, 5.00976694635767, 5.00965494503268, 5.00960324754263, 5.0095424950609, 5.00967154337183, 5.00986556215779, 
        0.522252317917437, 0.522237917704138, 0.52212071100198, 0.521954051272421, 0.522543649951873, 0.522136681332516, 
        0.52153697058446, 0.521947510352233, 0.521662025726321, 0.522405148118915, 0.522069921763686, 0.522092272184932, 
        0.522366105580611, 0.521620956088117, 0.521555713927878, 0.522318708266967, 0.521994854365399, 0.521921340256566, 
        0.522159580790734, 0.521632463330819, 0.522022729535773, 0.522138647757131, 0.522379812832502, 0.522404080440113, 
        0.522378767955423, 0.522428048462174, 0.52188559482346, 0.522299528672399, 0.522235119396706, 0.522015347961827, 
        0.521560086350218, 0.522001147752128, 0.521838401814087, 0.521666289619311, 0.521877357531184, 0.521733580945829, 
        0.522372159639245, 0.522062910684066, 0.521814098903903, 0.521783712776904, 0.522386879247828, 0.521891596577713, 
        0.521691161195813, 0.522007966998991, 0.522149329129284, 0.521793987960912, 0.521701487565873, 0.521571123494987, 
        0.521635610989483, 0.522234571881577), .Dim = c(50L, 3L), .Dimnames = list(NULL, c("amplitude", "phase", "period"))), 
        popcost = c(0.064171743407366, 0.0641669525559328, 0.0641809624835309, 0.0641731943311103, 0.0641756987879102, 0.0641732020094064, 
            0.0641769562723081, 0.0641638447114969, 0.064177679182457, 0.064181041354809, 0.0641677754502275, 0.0641643268199193, 
            0.0641735939218754, 0.0641760042618033, 0.0641757891057878, 0.0641652350305878, 0.0641685800159332, 0.0641730384626213, 
            0.0641698456102169, 0.0641808503799894, 0.0641657676969821, 0.0641761958531292, 0.0641809909550053, 0.0641795593508014, 
            0.0641783730533258, 0.064176125097073, 0.0641642901065604, 0.06416790744404, 0.0641633227587059, 0.0641637280831615, 
            0.0641801057992576, 0.0641656348791968, 0.0641652143749257, 0.0641768297192355, 0.0641696890089711, 0.0641712116255739, 
            0.0641690743594837, 0.0641741859138229, 0.0641689519178394, 0.0641689385208412, 0.064182139411322, 0.0641717235899845, 
            0.0641739105252808, 0.0641673470034899, 0.0641671336053944, 0.0641658799893951, 0.06417204788663, 0.0641824791886041, 
            0.0641816063169849, 0.0641660321345953)))
})
