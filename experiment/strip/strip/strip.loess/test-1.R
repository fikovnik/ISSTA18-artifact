library(testthat)

.Random.seed <<- .ext.seed

test_that("strip.loess", {
    cars <- structure(list(speed = c(4, 4, 7, 7, 8, 9, 10, 10, 10, 11, 11, 12, 12, 12, 12, 13, 13, 13, 13, 14, 14, 14, 14, 
        15, 15, 15, 16, 16, 17, 17, 17, 18, 18, 18, 18, 19, 19, 19, 20, 20, 20, 20, 20, 22, 23, 24, 24, 24, 24, 25), dist = c(2, 
        10, 4, 22, 16, 10, 18, 26, 34, 17, 28, 14, 20, 24, 28, 26, 34, 34, 46, 26, 36, 60, 80, 20, 26, 54, 32, 40, 32, 40, 
        50, 42, 56, 76, 84, 36, 46, 68, 32, 48, 52, 56, 64, 66, 54, 70, 92, 93, 120, 85)), row.names = c(NA, -50L), class = "data.frame")
    i <- c(1L, 2L, 2L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 2L, 1L, 1L, 
        1L, 2L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 1L)
    r1 <- structure(list(n = 40L, fitted = c(4.82674211881649, 12.4075202712385, 15.1903066562198, 18.0593395281604, 20.9896086789835, 
        20.9896086789835, 23.8769921186624, 23.8769921186624, 26.929404287383, 26.929404287383, 26.929404287383, 26.929404287383, 
        30.6266791418691, 30.6266791418691, 30.6266791418691, 34.0696016563523, 34.0696016563523, 34.0696016563523, 37.4696543662606, 
        37.4696543662606, 41.3349923584808, 41.3349923584808, 44.8929725167324, 44.8929725167324, 47.4895778802362, 47.4895778802362, 
        47.4895778802362, 50.5501411714727, 50.5501411714727, 50.5501411714727, 54.7130851970593, 54.7130851970593, 54.7130851970593, 
        54.7130851970593, 65.1954052468327, 71.7242470393456, 79.1002397018927, 79.1002397018927, 79.1002397018927, 87.3819310103189), 
        residuals = structure(c(-2.82674211881649, 9.59247972876153, 0.809693343780161, -8.05933952816041, -2.9896086789835, 
            5.0103913210165, -6.87699211866237, 4.12300788133763, -12.929404287383, -6.92940428738297, -2.92940428738297, 
            1.07059571261703, -4.62667914186908, 3.37332085813092, 15.3733208581309, -8.06960165635229, 1.93039834364771, 
            45.9303983436477, -17.4696543662606, -11.4696543662606, -9.3349923584808, -1.3349923584808, -12.8929725167324, 
            5.10702748326758, -5.48957788023616, 8.51042211976384, 36.5104221197638, -14.5501411714727, -4.55014117147267, 
            17.4498588285273, -22.7130851970593, -6.71308519705927, -2.71308519705927, 9.28691480294073, 0.804594753167279, 
            -17.7242470393456, -9.10023970189269, 12.8997602981073, 13.8997602981073, -2.38193101031885), names = c("1", 
            "4", "5", "6", "7", "8", "10", "11", "12", "13", "14", "15", "16", "17", "19", "20", "21", "23", "24", "25", 
            "27", "28", "29", "31", "32", "33", "35", "36", "37", "38", "39", "40", "41", "43", "44", "45", "46", "47", "48", 
            "50")), enp = 4.83696459613027, s = 14.3475748160541, one.delta = 34.2202618176886, two.delta = 33.9073952324982, 
        trace.hat = 5.30835138922085, divisor = 1, robust = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1), pars = list(span = 0.75, degree = 2L, normalize = TRUE, 
            parametric = FALSE, drop.square = FALSE, surface = "interpolate", cell = 0.2, family = "gaussian", trace.hat = "exact", 
            iterations = 1L), kd = list(parameter = structure(c(1L, 40L, 2L, 15L, 9L, 1049L, 849L), names = c("d", "n", "vc", 
            "nc", "nv", "liv", "lv")), a = c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L), xi = c(15, 12, 
            19, 10, 13, 17, 22, 0, 0, 0, 0, 0, 0, 0, 0), vert = c(3.895, 25.105), vval = c(4.58784776274851, 2.26531234672848, 
            88.3064336532281, 8.85562517554253, 37.4696543662606, 3.57274430080348, 26.929404287383, 3.28260801232228, 50.5501411714727, 
            3.88594448833178, 20.9896086789835, 2.95255055423879, 30.6266791418691, 3.65848390995334, 44.8929725167324, 2.95802863286622, 
            65.1954052468327, 6.12478228277727)), call = stats::loess(formula = dist ~ speed, data = cars[i == 1, ]), terms = dist ~ 
            speed, xnames = structure("speed", names = "speed"), x = structure(c(4, 7, 8, 9, 10, 10, 11, 11, 12, 12, 12, 
            12, 13, 13, 13, 14, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 18, 19, 19, 19, 20, 20, 20, 20, 22, 23, 24, 24, 24, 
            25), .Dim = c(40L, 1L), .Dimnames = list(c("1", "4", "5", "6", "7", "8", "10", "11", "12", "13", "14", "15", 
            "16", "17", "19", "20", "21", "23", "24", "25", "27", "28", "29", "31", "32", "33", "35", "36", "37", "38", "39", 
            "40", "41", "43", "44", "45", "46", "47", "48", "50"), "speed")), y = structure(c(2, 22, 16, 10, 18, 26, 17, 
            28, 14, 20, 24, 28, 26, 34, 46, 26, 36, 80, 20, 26, 32, 40, 32, 50, 42, 56, 84, 36, 46, 68, 32, 48, 52, 64, 66, 
            54, 70, 92, 93, 85), names = c("1", "4", "5", "6", "7", "8", "10", "11", "12", "13", "14", "15", "16", "17", 
            "19", "20", "21", "23", "24", "25", "27", "28", "29", "31", "32", "33", "35", "36", "37", "38", "39", "40", "41", 
            "43", "44", "45", "46", "47", "48", "50")), weights = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)), class = "loess")
    expect_equal(strip:::strip.loess(object = r1, keep = "predict"), structure(list(n = 40L, enp = 4.83696459613027, s = 14.3475748160541, 
        trace.hat = 5.30835138922085, divisor = 1, robust = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1), pars = list(span = 0.75, degree = 2L, normalize = TRUE, 
            parametric = FALSE, drop.square = FALSE, surface = "interpolate", cell = 0.2, family = "gaussian", trace.hat = "exact", 
            iterations = 1L), kd = list(parameter = structure(c(1L, 40L, 2L, 15L, 9L, 1049L, 849L), names = c("d", "n", "vc", 
            "nc", "nv", "liv", "lv")), a = c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L), xi = c(15, 12, 
            19, 10, 13, 17, 22, 0, 0, 0, 0, 0, 0, 0, 0), vert = c(3.895, 25.105), vval = c(4.58784776274851, 2.26531234672848, 
            88.3064336532281, 8.85562517554253, 37.4696543662606, 3.57274430080348, 26.929404287383, 3.28260801232228, 50.5501411714727, 
            3.88594448833178, 20.9896086789835, 2.95255055423879, 30.6266791418691, 3.65848390995334, 44.8929725167324, 2.95802863286622, 
            65.1954052468327, 6.12478228277727)), call = stats::loess(formula = dist ~ speed, data = cars[i == 1, ]), terms = dist ~ 
            speed, xnames = structure("speed", names = "speed"), x = structure(c(4, 7, 8, 9, 10, 10, 11, 11, 12, 12, 12, 
            12, 13, 13, 13, 14, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 18, 19, 19, 19, 20, 20, 20, 20, 22, 23, 24, 24, 24, 
            25), .Dim = c(40L, 1L), .Dimnames = list(c("1", "4", "5", "6", "7", "8", "10", "11", "12", "13", "14", "15", 
            "16", "17", "19", "20", "21", "23", "24", "25", "27", "28", "29", "31", "32", "33", "35", "36", "37", "38", "39", 
            "40", "41", "43", "44", "45", "46", "47", "48", "50"), "speed"))), class = "loess"))
})
