library(testthat)

.Random.seed <<- .ext.seed

test_that("logdiag", {
    binomial <- stats::binomial
    glm <- stats::glm
    menarche <- structure(list(Age = c(9.21, 10.21, 10.58, 10.83, 11.08, 11.33, 11.58, 11.83, 12.08, 12.33, 12.58, 12.83, 
        13.08, 13.33, 13.58, 13.83, 14.08, 14.33, 14.58, 14.83, 15.08, 15.33, 15.58, 15.83, 17.58), Total = c(376, 200, 93, 
        120, 90, 88, 105, 111, 100, 93, 100, 108, 99, 106, 105, 117, 98, 97, 120, 102, 122, 111, 94, 114, 1049), Menarche = c(0, 
        0, 0, 2, 2, 5, 10, 17, 16, 29, 39, 51, 47, 67, 81, 88, 79, 90, 113, 95, 117, 107, 92, 112, 1049)), class = "data.frame", 
        row.names = c(NA, 25L))
    glm.out <- structure(list(coefficients = structure(c(-21.2263949051281, 1.63196834822456), names = c("(Intercept)", "Age")), 
        residuals = structure(c(-1.00203763304264, -1.01042031440638, -1.01905987801341, -0.413364237613317, -0.482127006471674, 
            -0.0708982572845284, 0.0793808619903615, 0.227048664179941, -0.139268775079495, 0.336298565239545, 0.258350472716489, 
            0.178813934129867, -0.221410169849836, 0.0133645238329613, 0.262838040287166, -0.249650880089489, -0.365520963154836, 
            0.337131950495693, 0.195145143047822, -0.435065310858362, -0.257602723125177, -0.647833876133057, -0.446264595894276, 
            -0.784054248703092, 1.00057358256977), names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", 
            "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), fitted.values = structure(c(0.00203348953716697, 
            0.010312851253886, 0.0187033936127185, 0.0278635255768025, 0.041320993783309, 0.0608711405932617, 0.0888141068017117, 
            0.127838223381194, 0.180610427983941, 0.248949061922587, 0.332647929969137, 0.428434554458579, 0.529902047197492, 
            0.628956590126872, 0.718237396177411, 0.793102234679979, 0.852169542118999, 0.896572801304775, 0.928753893222787, 
            0.95146398331318, 0.967190830549173, 0.977939947544758, 0.985221192678276, 0.99012342726807, 0.999426746238646), 
            names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", 
                "19", "20", "21", "22", "23", "24", "25")), effects = structure(c(-0.578222061752367, 27.682494719076, -1.06870244997311, 
            -0.412570581354292, -0.593129079722282, 0.180716276037979, 0.624754408062361, 1.21532548240981, -0.143804678969495, 
            1.75829442130272, 1.54155603982357, 1.18855768340656, -0.921865675131167, 0.162204071683886, 1.22413753443425, 
            -1.15437586983774, -1.39089792497926, 0.870554362065169, 0.371265863737039, -1.11769067225004, -0.696621599693457, 
            -1.17732239926134, -0.673591352724348, -0.982023130939767, 0.57278174875359), names = c("(Intercept)", "Age", 
            "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "")), R = structure(c(-15.8509657340396, 
            0, -206.521824229494, 16.9626419220643), .Dim = c(2L, 2L), .Dimnames = list(c("(Intercept)", "Age"), c("(Intercept)", 
            "Age"))), rank = 2L, qr = structure(list(qr = structure(c(-15.8509657340396, 0.0901360964884267, 0.0824227441884423, 
            0.113741093814062, 0.119120977497227, 0.141499379063359, 0.183900911155161, 0.221939710888154, 0.24269517841437, 
            0.263072731589327, 0.297244791095345, 0.324437756902781, 0.31329527864378, 0.313776153573888, 0.290813594603156, 
            0.276426633118256, 0.221667784451503, 0.189208536187183, 0.177773218689879, 0.136922011318304, 0.124130550141853, 
            0.0976261203420097, 0.0738066993437117, 0.066610950227342, 0.0489083291184938, -206.521824229494, 16.9626419220643, 
            0.173259453909023, 0.212521507529198, 0.194745099584962, 0.198273968334403, 0.214726343483675, 0.207292572231534, 
            0.169980829273293, 0.122795075384088, 0.0693045632628669, -0.000149010569311803, -0.073334625113557, -0.146750258109984, 
            -0.203949532963223, -0.25843749340579, -0.259027311177245, -0.265299540738394, -0.290796098000239, -0.255960065900764, 
            -0.261046749564785, -0.228114896195917, -0.189700433774835, -0.186767051524451, -0.217111888112537), .Dim = c(25L, 
            2L), .Dimnames = list(c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", 
            "17", "18", "19", "20", "21", "22", "23", "24", "25"), c("(Intercept)", "Age"))), rank = 2L, qraux = c(1.05510851542802, 
            1.22063824331514), pivot = 1:2, tol = 1e-11), class = "qr"), family = structure(list(family = "binomial", link = "logit", 
            linkfun = genthat::with_env(function(mu) .Call(C_logit_link, mu), env = getNamespace("stats")), linkinv = genthat::with_env(function(eta) .Call(C_logit_linkinv, 
                eta), env = getNamespace("stats")), variance = genthat::with_env(function(mu) mu * (1 - mu), env = list2env(list(), 
                parent = baseenv())), dev.resids = genthat::with_env(function(y, mu, wt) .Call(C_binomial_dev_resids, y, 
                mu, wt), env = list2env(list(C_binomial_dev_resids = stats:::C_binomial_dev_resids), parent = baseenv())), 
            aic = genthat::with_env(function(y, n, mu, wt, dev) {
                m <- if (any(n > 1)) n else wt
                -2 * sum(ifelse(m > 0, (wt/m), 0) * dbinom(round(m * y), round(m), mu, log = TRUE))
            }, env = list2env(list(dbinom = stats::dbinom), parent = baseenv())), mu.eta = genthat::with_env(function(eta) .Call(C_logit_mu_eta, 
                eta), env = getNamespace("stats")), initialize = expression({
                if (NCOL(y) == 1) {
                  if (is.factor(y)) y <- y != levels(y)[1L]
                  n <- rep.int(1, nobs)
                  y[weights == 0] <- 0
                  if (any(y < 0 | y > 1)) stop("y values must be 0 <= y <= 1")
                  mustart <- (weights * y + 0.5)/(weights + 1)
                  m <- weights * y
                  if (any(abs(m - round(m)) > 0.001)) warning("non-integer #successes in a binomial glm!")
                } else if (NCOL(y) == 2) {
                  if (any(abs(y - round(y)) > 0.001)) warning("non-integer counts in a binomial glm!")
                  n <- y[, 1] + y[, 2]
                  y <- ifelse(n == 0, 0, y[, 1]/n)
                  weights <- weights * n
                  mustart <- (n * y + 0.5)/(n + 1)
                } else stop("for the 'binomial' family, y must be a vector of 0 and 1's\nor a 2 column matrix where col 1 is no. successes and col 2 is no. failures")
            }), validmu = genthat::with_env(function(mu) all(is.finite(mu)) && all(mu > 0 & mu < 1), env = list2env(list(), 
                parent = baseenv())), valideta = genthat::with_env(function(eta) TRUE, env = getNamespace("stats")), simulate = genthat::with_env(function(object, 
                nsim) {
                ftd <- fitted(object)
                n <- length(ftd)
                ntot <- n * nsim
                wts <- object$prior.weights
                if (any(wts%%1 != 0)) stop("cannot simulate from non-integer prior.weights")
                if (!is.null(m <- object$model)) {
                  y <- model.response(m)
                  if (is.factor(y)) {
                    yy <- factor(1 + rbinom(ntot, size = 1, prob = ftd), labels = levels(y))
                    split(yy, rep(seq_len(nsim), each = n))
                  } else if (is.matrix(y) && ncol(y) == 2) {
                    yy <- vector("list", nsim)
                    for (i in seq_len(nsim)) {
                      Y <- rbinom(n, size = wts, prob = ftd)
                      YY <- cbind(Y, wts - Y)
                      colnames(YY) <- colnames(y)
                      yy[[i]] <- YY
                    }
                    yy
                  } else rbinom(ntot, size = wts, prob = ftd)/wts
                } else rbinom(ntot, size = wts, prob = ftd)/wts
            }, env = list2env(list(rbinom = stats::rbinom, model.response = stats::model.response, fitted = stats::fitted), 
                parent = baseenv()))), class = "family"), linear.predictors = structure(c(-6.1959664179799, -4.56399806975534, 
            -3.96016978091225, -3.55217769385611, -3.14418560679997, -2.73619351974383, -2.32820143268769, -1.92020934563155, 
            -1.51221725857541, -1.10422517151927, -0.696233084463127, -0.288240997406987, 0.119751089649153, 0.527743176705293, 
            0.935735263761437, 1.34372735081758, 1.75171943787372, 2.15971152492986, 2.567703611986, 2.97569569904214, 3.38368778609828, 
            3.79167987315442, 4.19967196021056, 4.6076640472667, 7.46360865665968), names = c("1", "2", "3", "4", "5", "6", 
            "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), 
        deviance = 26.703451635765, aic = 114.755254313104, null.deviance = 3693.88357479415, iter = 4L, weights = structure(c(0.763042762949478, 
            2.04130992284889, 1.70689023559105, 3.25047069604161, 3.56523327609039, 5.0306085244619, 8.49726605012385, 12.3760337829601, 
            14.7990470523155, 17.3885401640766, 22.1993347384251, 26.4468672017158, 24.6614810398639, 24.7372446405293, 21.2491158032648, 
            19.1986734782453, 12.3457254701112, 8.99482888514807, 7.94043190235007, 4.71040223563911, 3.87140685402726, 2.39465810325829, 
            1.36868347020422, 1.11481476589974, 0.601003645555441), names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", 
            "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), prior.weights = structure(c(376, 
            200, 93, 120, 90, 88, 105, 111, 100, 93, 100, 108, 99, 106, 105, 117, 98, 97, 120, 102, 122, 111, 94, 114, 1049), 
            names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", 
                "19", "20", "21", "22", "23", "24", "25")), df.residual = 23L, df.null = 24L, y = structure(c(0, 0, 0, 0.0166666666666667, 
            0.0222222222222222, 0.0568181818181818, 0.0952380952380952, 0.153153153153153, 0.16, 0.311827956989247, 0.39, 
            0.472222222222222, 0.474747474747475, 0.632075471698113, 0.771428571428571, 0.752136752136752, 0.806122448979592, 
            0.927835051546392, 0.941666666666667, 0.931372549019608, 0.959016393442623, 0.963963963963964, 0.978723404255319, 
            0.982456140350877, 1), names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", 
            "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), converged = TRUE, boundary = FALSE, model = structure(list(`cbind(Menarche, Total - Menarche)` = structure(c(0, 
            0, 0, 2, 2, 5, 10, 17, 16, 29, 39, 51, 47, 67, 81, 88, 79, 90, 113, 95, 117, 107, 92, 112, 1049, 376, 200, 93, 
            118, 88, 83, 95, 94, 84, 64, 61, 57, 52, 39, 24, 29, 19, 7, 7, 7, 5, 4, 2, 2, 0), .Dim = c(25L, 2L), .Dimnames = list(NULL, 
            c("Menarche", ""))), Age = c(9.21, 10.21, 10.58, 10.83, 11.08, 11.33, 11.58, 11.83, 12.08, 12.33, 12.58, 12.83, 
            13.08, 13.33, 13.58, 13.83, 14.08, 14.33, 14.58, 14.83, 15.08, 15.33, 15.58, 15.83, 17.58)), terms = cbind(Menarche, 
            Total - Menarche) ~ Age, row.names = c(NA, 25L), class = "data.frame"), call = glm(formula = cbind(Menarche, 
            Total - Menarche) ~ Age, family = binomial, data = menarche), formula = cbind(Menarche, Total - Menarche) ~ Age, 
        terms = cbind(Menarche, Total - Menarche) ~ Age, data = structure(list(Age = c(9.21, 10.21, 10.58, 10.83, 11.08, 
            11.33, 11.58, 11.83, 12.08, 12.33, 12.58, 12.83, 13.08, 13.33, 13.58, 13.83, 14.08, 14.33, 14.58, 14.83, 15.08, 
            15.33, 15.58, 15.83, 17.58), Total = c(376, 200, 93, 120, 90, 88, 105, 111, 100, 93, 100, 108, 99, 106, 105, 
            117, 98, 97, 120, 102, 122, 111, 94, 114, 1049), Menarche = c(0, 0, 0, 2, 2, 5, 10, 17, 16, 29, 39, 51, 47, 67, 
            81, 88, 79, 90, 113, 95, 117, 107, 92, 112, 1049)), class = "data.frame", row.names = c(NA, 25L)), offset = NULL, 
        control = list(epsilon = 1e-08, maxit = 25, trace = FALSE), method = "glm.fit", contrasts = NULL, xlevels = structure(list(), 
            names = character())), class = c("glm", "lm"))
    expect_equal(HoRM:::logdiag(out = glm.out), structure(list(r.i = c(-0.00203348953716697, -0.010312851253886, -0.0187033936127185, 
        -0.0111968589101358, -0.0190987715610867, -0.00405295877507987, 0.00642398843638352, 0.0253149297719592, -0.0206104279839414, 
        0.0628788950666603, 0.0573520700308632, 0.0437876677636431, -0.0551545724500169, 0.00311888157124096, 0.0531911752511607, 
        -0.0409654825432265, -0.046047093139407, 0.0312622502416164, 0.0129127734438793, -0.0200914342935723, -0.00817443710654964, 
        -0.0139759835807943, -0.00649778842295667, -0.00766728691719298, 0.000573253761353532), p.i = c(-0.875299962317233, 
        -1.44362837367362, -1.33137847933917, -0.745255476763681, -0.910342254541103, -0.159017605415028, 0.231395511294202, 
        0.798747162578429, -0.535760119753949, 1.40235004336051, 1.21724830678636, 0.919577769975093, -1.09953014609022, 
        0.0664705266388764, 1.211598014061, -1.09387707084216, -1.28431126593597, 1.01110426261664, 0.549894355764809, -0.944240850030005, 
        -0.506855389195821, -1.00250029095601, -0.522087056848819, -0.82783987142043, 0.775685577818296), d.i = c(-1.23723119622074, 
        -2.03631011029038, -1.87397321614761, -0.804382661465599, -0.995331982415651, -0.160716281921865, 0.228953219514016, 
        0.77802520640619, -0.544154810073648, 1.36753877427257, 1.20169441113091, 0.91628255606525, -1.09822552458985, 0.0665089993663903, 
        1.2375553243823, -1.06951336848253, -1.23581202974266, 1.06330437117526, 0.566550325342927, -0.891257678164386, -0.488396443428366, 
        -0.919574304478523, -0.490006974770514, -0.746189332560216, 1.09682781026347), stud.r.i = c(-1.25063645380341, -2.07129264556495, 
        -1.89478391258225, -0.829020732709492, -1.02213646698038, -0.16657527045559, 0.241027044548205, 0.82768066992466, 
        -0.574332754134563, 1.4441605295482, 1.27117259018192, 0.97103802914963, -1.15672425440665, 0.0703468654666515, 1.30668615648965, 
        -1.142729357359, -1.305171885923, 1.10911741589438, 0.594835767152587, -0.929171537573228, -0.508395483789964, -0.950016917393945, 
        -0.500404216481702, -0.762583440112274, 1.10987159358357), stud.p.i = c(-1.25063645380341, -2.07129264556495, -1.89478391258225, 
        -0.829020732709492, -1.02213646698038, -0.16657527045559, 0.241027044548205, 0.82768066992466, -0.574332754134563, 
        1.4441605295482, 1.27117259018192, 0.97103802914963, -1.15672425440665, 0.0703468654666515, 1.30668615648965, -1.142729357359, 
        -1.305171885923, 1.10911741589438, 0.594835767152587, -0.929171537573228, -0.508395483789964, -0.950016917393945, 
        -0.500404216481702, -0.762583440112274, 1.10987159358357), stud.d.i = c(-1.25063645380341, -2.07129264556495, -1.89478391258225, 
        -0.829020732709492, -1.02213646698038, -0.16657527045559, 0.241027044548205, 0.82768066992466, -0.574332754134563, 
        1.4441605295482, 1.27117259018192, 0.97103802914963, -1.15672425440665, 0.0703468654666515, 1.30668615648965, -1.142729357359, 
        -1.305171885923, 1.10911741589438, 0.594835767152587, -0.929171537573228, -0.508395483789964, -0.950016917393945, 
        -0.500404216481702, -0.762583440112274, 1.10987159358357), h.ii = c(0.0417141770380701, 0.064501802866075, 0.0423719600257271, 
        0.0675630552621406, 0.0612564434679034, 0.0704890316372822, 0.0958226670013774, 0.111089364555991, 0.105219569411218, 
        0.0987328446734366, 0.103906808601185, 0.108898848885565, 0.0983770889359015, 0.106246088035723, 0.106995751373729, 
        0.119224835131661, 0.0965342062351463, 0.0887147370995514, 0.0979921692229209, 0.0718496343114355, 0.0720093871811254, 
        0.0535964391402579, 0.0364034918633908, 0.0348353629809453, 0.0456542350622407), C.i = c(0.0348022540676852, 0.153601961757753, 
        0.0819007561056693, 0.0431599256365967, 0.0576059367176288, 0.00206301756281831, 0.00627582584822213, 0.089696383848208, 
        0.0377228356718684, 0.239038263729885, 0.191732621043982, 0.115970147021006, 0.146304731449506, 0.000587672375173501, 
        0.196959343614875, 0.183896578000672, 0.195073549174129, 0.109214162163718, 0.0364191059289691, 0.0743624092611568, 
        0.0214817711614551, 0.0601384485766628, 0.0106865731267824, 0.0256277345419577, 0.0301606712513186), C.i.bar = c(0.0333505066801819, 
        0.143694358300612, 0.078430460541883, 0.0402439091957014, 0.0540772019116698, 0.00191759745256454, 0.00567445947780931, 
        0.0797320695635403, 0.0337536551455043, 0.215437335966034, 0.171810296286561, 0.103341131505329, 0.131911697871954, 
        0.000525234484264655, 0.175885530654725, 0.161971538807265, 0.176242278947132, 0.0995252564798164, 0.0328503187378301, 
        0.0690194973492254, 0.0199348819845535, 0.0569152418775342, 0.010297544548914, 0.0247349831068093, 0.028783708876376), 
        DFDEV = c(-1.20388068954055, -1.89261575198977, -1.79554275560573, -0.764138752269898, -0.941254780503981, -0.158798684469301, 
            0.234627678991826, 0.85775727596973, -0.510401154928144, 1.5829761102386, 1.37350470741747, 1.01962368757058, 
            -0.966313826717899, 0.0670342338506549, 1.41344085503703, -0.907541829675267, -1.05956975079553, 1.16282962765507, 
            0.599400644080757, -0.82223818081516, -0.468461561443813, -0.862659062600989, -0.4797094302216, -0.721454349453407, 
            1.12561151913985), DFCHI = c(0.799500530712732, 2.22775723957615, 1.85099911578936, 0.595649634841963, 0.882800222314647, 
            0.0272041962844941, 0.0592183421249143, 0.717729099290631, 0.32079256106427, 2.18202298007925, 1.65350373666083, 
            0.948964406537694, 1.34087824003313, 0.00494356539591423, 1.64385527833128, 1.3585385849215, 1.82569770675719, 
            1.12185708636136, 0.335234121239824, 0.960610280214612, 0.276837267541401, 1.06192207524443, 0.282872439477976, 
            0.710053835820203, 0.63047182451168), fit = c(0.00203348953716697, 0.010312851253886, 0.0187033936127185, 0.0278635255768025, 
            0.041320993783309, 0.0608711405932617, 0.0888141068017117, 0.127838223381194, 0.180610427983941, 0.248949061922587, 
            0.332647929969137, 0.428434554458579, 0.529902047197492, 0.628956590126872, 0.718237396177411, 0.793102234679979, 
            0.852169542118999, 0.896572801304775, 0.928753893222787, 0.95146398331318, 0.967190830549173, 0.977939947544758, 
            0.985221192678276, 0.99012342726807, 0.999426746238646)), row.names = c("1", "2", "3", "4", "5", "6", "7", "8", 
        "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25"), class = "data.frame"))
})
