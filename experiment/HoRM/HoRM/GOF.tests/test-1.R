library(testthat)

.Random.seed <<- .ext.seed

test_that("GOF.tests", {
    binomial <- stats::binomial
    glm <- stats::glm
    menarche <- structure(list(Age = c(9.21, 10.21, 10.58, 10.83, 11.08, 11.33, 11.58, 11.83, 12.08, 12.33, 12.58, 12.83, 
        13.08, 13.33, 13.58, 13.83, 14.08, 14.33, 14.58, 14.83, 15.08, 15.33, 15.58, 15.83, 17.58), Total = c(376, 200, 93, 
        120, 90, 88, 105, 111, 100, 93, 100, 108, 99, 106, 105, 117, 98, 97, 120, 102, 122, 111, 94, 114, 1049), Menarche = c(0, 
        0, 0, 2, 2, 5, 10, 17, 16, 29, 39, 51, 47, 67, 81, 88, 79, 90, 113, 95, 117, 107, 92, 112, 1049)), class = "data.frame", 
        row.names = c(NA, 25L))
    glm.out <- structure(list(coefficients = structure(c(-21.2263949051281, 1.63196834822456), names = c("(Intercept)", "Age")), 
        residuals = structure(c(-1.00203763304264, -1.01042031440638, -1.01905987801341, -0.413364237613317, -0.482127006471674, 
            -0.0708982572845284, 0.0793808619903615, 0.227048664179941, -0.139268775079495, 0.336298565239545, 0.258350472716489, 
            0.178813934129867, -0.221410169849836, 0.0133645238329613, 0.262838040287166, -0.249650880089489, -0.365520963154836, 
            0.337131950495693, 0.195145143047822, -0.435065310858362, -0.257602723125177, -0.647833876133057, -0.446264595894276, 
            -0.784054248703092, 1.00057358256977), names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", 
            "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), fitted.values = structure(c(0.00203348953716697, 
            0.010312851253886, 0.0187033936127185, 0.0278635255768025, 0.041320993783309, 0.0608711405932617, 0.0888141068017117, 
            0.127838223381194, 0.180610427983941, 0.248949061922587, 0.332647929969137, 0.428434554458579, 0.529902047197492, 
            0.628956590126872, 0.718237396177411, 0.793102234679979, 0.852169542118999, 0.896572801304775, 0.928753893222787, 
            0.95146398331318, 0.967190830549173, 0.977939947544758, 0.985221192678276, 0.99012342726807, 0.999426746238646), 
            names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", 
                "19", "20", "21", "22", "23", "24", "25")), effects = structure(c(-0.578222061752367, 27.682494719076, -1.06870244997311, 
            -0.412570581354292, -0.593129079722282, 0.180716276037979, 0.624754408062361, 1.21532548240981, -0.143804678969495, 
            1.75829442130272, 1.54155603982357, 1.18855768340656, -0.921865675131167, 0.162204071683886, 1.22413753443425, 
            -1.15437586983774, -1.39089792497926, 0.870554362065169, 0.371265863737039, -1.11769067225004, -0.696621599693457, 
            -1.17732239926134, -0.673591352724348, -0.982023130939767, 0.57278174875359), names = c("(Intercept)", "Age", 
            "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "")), R = structure(c(-15.8509657340396, 
            0, -206.521824229494, 16.9626419220643), .Dim = c(2L, 2L), .Dimnames = list(c("(Intercept)", "Age"), c("(Intercept)", 
            "Age"))), rank = 2L, qr = structure(list(qr = structure(c(-15.8509657340396, 0.0901360964884267, 0.0824227441884423, 
            0.113741093814062, 0.119120977497227, 0.141499379063359, 0.183900911155161, 0.221939710888154, 0.24269517841437, 
            0.263072731589327, 0.297244791095345, 0.324437756902781, 0.31329527864378, 0.313776153573888, 0.290813594603156, 
            0.276426633118256, 0.221667784451503, 0.189208536187183, 0.177773218689879, 0.136922011318304, 0.124130550141853, 
            0.0976261203420097, 0.0738066993437117, 0.066610950227342, 0.0489083291184938, -206.521824229494, 16.9626419220643, 
            0.173259453909023, 0.212521507529198, 0.194745099584962, 0.198273968334403, 0.214726343483675, 0.207292572231534, 
            0.169980829273293, 0.122795075384088, 0.0693045632628669, -0.000149010569311803, -0.073334625113557, -0.146750258109984, 
            -0.203949532963223, -0.25843749340579, -0.259027311177245, -0.265299540738394, -0.290796098000239, -0.255960065900764, 
            -0.261046749564785, -0.228114896195917, -0.189700433774835, -0.186767051524451, -0.217111888112537), .Dim = c(25L, 
            2L), .Dimnames = list(c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", 
            "17", "18", "19", "20", "21", "22", "23", "24", "25"), c("(Intercept)", "Age"))), rank = 2L, qraux = c(1.05510851542802, 
            1.22063824331514), pivot = 1:2, tol = 1e-11), class = "qr"), family = structure(list(family = "binomial", link = "logit", 
            linkfun = genthat::with_env(function(mu) .Call(C_logit_link, mu), env = getNamespace("stats")), linkinv = genthat::with_env(function(eta) .Call(C_logit_linkinv, 
                eta), env = getNamespace("stats")), variance = genthat::with_env(function(mu) mu * (1 - mu), env = list2env(list(), 
                parent = baseenv())), dev.resids = genthat::with_env(function(y, mu, wt) .Call(C_binomial_dev_resids, y, 
                mu, wt), env = list2env(list(C_binomial_dev_resids = stats:::C_binomial_dev_resids), parent = baseenv())), 
            aic = genthat::with_env(function(y, n, mu, wt, dev) {
                m <- if (any(n > 1)) n else wt
                -2 * sum(ifelse(m > 0, (wt/m), 0) * dbinom(round(m * y), round(m), mu, log = TRUE))
            }, env = list2env(list(dbinom = stats::dbinom), parent = baseenv())), mu.eta = genthat::with_env(function(eta) .Call(C_logit_mu_eta, 
                eta), env = getNamespace("stats")), initialize = expression({
                if (NCOL(y) == 1) {
                  if (is.factor(y)) y <- y != levels(y)[1L]
                  n <- rep.int(1, nobs)
                  y[weights == 0] <- 0
                  if (any(y < 0 | y > 1)) stop("y values must be 0 <= y <= 1")
                  mustart <- (weights * y + 0.5)/(weights + 1)
                  m <- weights * y
                  if (any(abs(m - round(m)) > 0.001)) warning("non-integer #successes in a binomial glm!")
                } else if (NCOL(y) == 2) {
                  if (any(abs(y - round(y)) > 0.001)) warning("non-integer counts in a binomial glm!")
                  n <- y[, 1] + y[, 2]
                  y <- ifelse(n == 0, 0, y[, 1]/n)
                  weights <- weights * n
                  mustart <- (n * y + 0.5)/(n + 1)
                } else stop("for the 'binomial' family, y must be a vector of 0 and 1's\nor a 2 column matrix where col 1 is no. successes and col 2 is no. failures")
            }), validmu = genthat::with_env(function(mu) all(is.finite(mu)) && all(mu > 0 & mu < 1), env = list2env(list(), 
                parent = baseenv())), valideta = genthat::with_env(function(eta) TRUE, env = getNamespace("stats")), simulate = genthat::with_env(function(object, 
                nsim) {
                ftd <- fitted(object)
                n <- length(ftd)
                ntot <- n * nsim
                wts <- object$prior.weights
                if (any(wts%%1 != 0)) stop("cannot simulate from non-integer prior.weights")
                if (!is.null(m <- object$model)) {
                  y <- model.response(m)
                  if (is.factor(y)) {
                    yy <- factor(1 + rbinom(ntot, size = 1, prob = ftd), labels = levels(y))
                    split(yy, rep(seq_len(nsim), each = n))
                  } else if (is.matrix(y) && ncol(y) == 2) {
                    yy <- vector("list", nsim)
                    for (i in seq_len(nsim)) {
                      Y <- rbinom(n, size = wts, prob = ftd)
                      YY <- cbind(Y, wts - Y)
                      colnames(YY) <- colnames(y)
                      yy[[i]] <- YY
                    }
                    yy
                  } else rbinom(ntot, size = wts, prob = ftd)/wts
                } else rbinom(ntot, size = wts, prob = ftd)/wts
            }, env = list2env(list(rbinom = stats::rbinom, model.response = stats::model.response, fitted = stats::fitted), 
                parent = baseenv()))), class = "family"), linear.predictors = structure(c(-6.1959664179799, -4.56399806975534, 
            -3.96016978091225, -3.55217769385611, -3.14418560679997, -2.73619351974383, -2.32820143268769, -1.92020934563155, 
            -1.51221725857541, -1.10422517151927, -0.696233084463127, -0.288240997406987, 0.119751089649153, 0.527743176705293, 
            0.935735263761437, 1.34372735081758, 1.75171943787372, 2.15971152492986, 2.567703611986, 2.97569569904214, 3.38368778609828, 
            3.79167987315442, 4.19967196021056, 4.6076640472667, 7.46360865665968), names = c("1", "2", "3", "4", "5", "6", 
            "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), 
        deviance = 26.703451635765, aic = 114.755254313104, null.deviance = 3693.88357479415, iter = 4L, weights = structure(c(0.763042762949478, 
            2.04130992284889, 1.70689023559105, 3.25047069604161, 3.56523327609039, 5.0306085244619, 8.49726605012385, 12.3760337829601, 
            14.7990470523155, 17.3885401640766, 22.1993347384251, 26.4468672017158, 24.6614810398639, 24.7372446405293, 21.2491158032648, 
            19.1986734782453, 12.3457254701112, 8.99482888514807, 7.94043190235007, 4.71040223563911, 3.87140685402726, 2.39465810325829, 
            1.36868347020422, 1.11481476589974, 0.601003645555441), names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", 
            "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), prior.weights = structure(c(376, 
            200, 93, 120, 90, 88, 105, 111, 100, 93, 100, 108, 99, 106, 105, 117, 98, 97, 120, 102, 122, 111, 94, 114, 1049), 
            names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", 
                "19", "20", "21", "22", "23", "24", "25")), df.residual = 23L, df.null = 24L, y = structure(c(0, 0, 0, 0.0166666666666667, 
            0.0222222222222222, 0.0568181818181818, 0.0952380952380952, 0.153153153153153, 0.16, 0.311827956989247, 0.39, 
            0.472222222222222, 0.474747474747475, 0.632075471698113, 0.771428571428571, 0.752136752136752, 0.806122448979592, 
            0.927835051546392, 0.941666666666667, 0.931372549019608, 0.959016393442623, 0.963963963963964, 0.978723404255319, 
            0.982456140350877, 1), names = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", 
            "16", "17", "18", "19", "20", "21", "22", "23", "24", "25")), converged = TRUE, boundary = FALSE, model = structure(list(`cbind(Menarche, Total - Menarche)` = structure(c(0, 
            0, 0, 2, 2, 5, 10, 17, 16, 29, 39, 51, 47, 67, 81, 88, 79, 90, 113, 95, 117, 107, 92, 112, 1049, 376, 200, 93, 
            118, 88, 83, 95, 94, 84, 64, 61, 57, 52, 39, 24, 29, 19, 7, 7, 7, 5, 4, 2, 2, 0), .Dim = c(25L, 2L), .Dimnames = list(NULL, 
            c("Menarche", ""))), Age = c(9.21, 10.21, 10.58, 10.83, 11.08, 11.33, 11.58, 11.83, 12.08, 12.33, 12.58, 12.83, 
            13.08, 13.33, 13.58, 13.83, 14.08, 14.33, 14.58, 14.83, 15.08, 15.33, 15.58, 15.83, 17.58)), terms = cbind(Menarche, 
            Total - Menarche) ~ Age, row.names = c(NA, 25L), class = "data.frame"), call = glm(formula = cbind(Menarche, 
            Total - Menarche) ~ Age, family = binomial, data = menarche), formula = cbind(Menarche, Total - Menarche) ~ Age, 
        terms = cbind(Menarche, Total - Menarche) ~ Age, data = structure(list(Age = c(9.21, 10.21, 10.58, 10.83, 11.08, 
            11.33, 11.58, 11.83, 12.08, 12.33, 12.58, 12.83, 13.08, 13.33, 13.58, 13.83, 14.08, 14.33, 14.58, 14.83, 15.08, 
            15.33, 15.58, 15.83, 17.58), Total = c(376, 200, 93, 120, 90, 88, 105, 111, 100, 93, 100, 108, 99, 106, 105, 
            117, 98, 97, 120, 102, 122, 111, 94, 114, 1049), Menarche = c(0, 0, 0, 2, 2, 5, 10, 17, 16, 29, 39, 51, 47, 67, 
            81, 88, 79, 90, 113, 95, 117, 107, 92, 112, 1049)), class = "data.frame", row.names = c(NA, 25L)), offset = NULL, 
        control = list(epsilon = 1e-08, maxit = 25, trace = FALSE), method = "glm.fit", contrasts = NULL, xlevels = structure(list(), 
            names = character())), class = c("glm", "lm"))
    expect_equal(HoRM:::GOF.tests(out = glm.out), structure(list(Statistic = c(21.8698536753736, 26.703451635765), p.value = c(0.528119985204012, 
        0.268795345618691)), row.names = c("Pearson", "Deviance"), class = "data.frame"))
})
